version: ~> 1.0
# Run conda tests on all versions from NEP 29
jobs:
  include:
    - &testpythonconda
      stage: test
      name: "Python 3.7"
      env:
        - PYTHON_VERSION: 3.7
      workspaces:
        use: conda
      install: skip
      before_script:
        - curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj micromamba
        - ./micromamba shell init -s bash -p ~/conda
        - ./micromamba activate
        - mamba config --set always_yes yes
        - mamba config --set changeps1 no
        - mamba config --set channel_priority strict
        - mamba config --remove channels defaults
        - mamba config --add channels pcds-tag
        - mamba config --add channels conda-forge
        # Useful for debugging
        - mamba info -a
        - mamba config --show
        - echo "Conda Environment Name':' ${CONDA_ENV_NAME:=testenv}"
        - echo "Conda Requirements':' ${CONDA_REQUIREMENTS:=dev-requirements.txt}"

        # Manage conda environment
        - mamba create -n ${CONDA_ENV_NAME} python=$PYTHON_VERSION ${CONDA_PACKAGE} ${CONDA_EXTRAS} --file ${CONDA_REQUIREMENTS}
        - ./micromamba activate ${CONDA_ENV_NAME}
        # Useful for debugging
        - mamba list
      script:
        - |
          set -e
          if command -v coverage; then
              if [ -f "run_tests.py" ]; then
                  coverage run --concurrency=thread --parallel-mode run_tests.py
              else
                  coverage run --concurrency=thread --parallel-mode -m pytest
              fi
              (coverage combine && coverage report | grep -v -e ' 0%') || true
          else
              if [ -f "run_tests.py" ]; then
                  python run_tests.py
              else
                  python -m pytest
              fi
          fi
    - <<: *testpythonconda
      name: "Python 3.8"
      env:
        - PYTHON_VERSION: 3.8
    - <<: *testpythonconda
      name: "Python 3.9"
      env:
        - PYTHON_VERSION: 3.9
