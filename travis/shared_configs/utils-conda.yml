before_install:
  - |
    if [[ -z "${SKIP_CONDA}" ]]; then
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
      bash miniconda.sh -b -p $HOME/miniconda
      export PATH="$HOME/miniconda/bin:$PATH"
      conda config --set always_yes yes --set changeps1 no
      conda install conda-build anaconda-client
      conda update -q conda conda-build
      conda config --remove channels defaults
      conda config --add channels conda-forge
      # Useful for debugging
      conda info -a

      if [[ ! -z "${CONDA_RECIPE_FOLDER}" ]]; then
        echo "Conda Recipe Folder':' ${CONDA_RECIPE_FOLDER}"
        conda build -q $CONDA_RECIPE_FOLDER --python $TRAVIS_PYTHON_VERSION --output-folder bld-dir
      fi

      conda config --add channels "file://`pwd`/bld-dir"

      echo "Conda Environment Name':' ${CONDA_ENV_NAME:=testenv}"
      echo "Conda Requirements':' ${CONDA_REQUIREMENTS:=dev-requirements.txt}"
      # Manage conda environment
      conda create -n ${CONDA_ENV_NAME} python=$TRAVIS_PYTHON_VERSION ${CONDA_PACKAGE} ${CONDA_EXTRAS} --file ${CONDA_REQUIREMENTS}
      source activate ${CONDA_ENV_NAME}
      # Useful for debugging
      conda list

    fi
